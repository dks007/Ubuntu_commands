from datetime import datetime

def construct_payload(request):
    startAt = int(request.GET.get('start', 0))  # Default value: 0
    maxResults = int(request.GET.get('max_result', 20))  # Default value: 20
    filterByCreatedDate = request.GET.get('filterByCreatedDate', False)  # Default value: False
    startDate = request.GET.get('startDate')
    endDate = request.GET.get('endDate')
    sortBy = request.GET.get('sortBy', 'created')  # Default value: 'created'
    order = request.GET.get('order', 'DESC')  # Default value: 'DESC'
    issueType = request.GET.get('issueType', 'Sub-task, Task')  # Default value: 'Sub-task, Task'
    issueKey = request.GET.get('issuekey', '')  # Filter by Issue Key
    status = request.GET.get('status', "('Awaiting Customer', 'In Process', 'In Review', 'Not Started')")  # Default value for status

    jql_parts = []

    if issueType:
        jql_parts.append(f"issuetype in ({issueType})")

    if issueKey:
        jql_parts.append(f"key in ({issueKey})")

    if filterByCreatedDate == 'True' and startDate and endDate:
        start_date_str = datetime.strptime(startDate, "%Y-%m-%d").strftime("%Y-%m-%d")
        end_date_str = datetime.strptime(endDate, "%Y-%m-%d").strftime("%Y-%m-%d")
        jql_parts.append(f"created >= '{start_date_str}' AND created <= '{end_date_str}'")

    if status:
        jql_parts.append(f"status in {status}")

    jql_parts.append("'Service Category[Dropdown]' = 'Expert Services'")
    jql_parts.append("assignee NOT in (EMPTY)")

    # Joining all JQL parts with AND and adding order by clause
    jql_query = " AND ".join(jql_parts) + f" order by {sortBy} {order}"

    payload = {
        "expand": ["changelog"],
        "jql": jql_query,
        "fieldsByKeys": False,
        "fields": [
            "summary", "description", "project", "customfield_16032",
            "customfield_16015", "customfield_16036", "customfield_16262",
            "customfield_16263", "customfield_16264", "customfield_16265",
            "customfield_16266", "assignee", "issuetype", "status",
            "parent", "created", "creator", "subtasks", "comment"
        ],
        "maxResults": maxResults,
        "startAt": startAt
    }

    return payload
